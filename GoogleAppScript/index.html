<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>REST API テスター</title>
    <?!= include('styles'); ?>
  </head>
  <body>
    <div class="container">
      <h1>REST API テスター</h1>

      <div class="form-group">
        <label for="endpoint">エンドポイント:</label>
        <input type="text" id="endpoint" placeholder="https://api.example.com/endpoint">
      </div>

      <div class="form-group">
        <label for="method">HTTPリクエストメソッド:</label>
        <select id="method">
          <option value="GET">GET</option>
          <option value="POST">POST</option>
          <option value="PUT">PUT</option>
          <option value="DELETE">DELETE</option>
          <option value="PATCH">PATCH</option>
        </select>
      </div>

      <div class="form-group">
        <label>パラメータ (Key-Value):</label>
        <div id="parameters">
          <div class="parameter-row">
            <input type="text" class="param-key" placeholder="Key">
            <input type="text" class="param-value" placeholder="Value">
            <button class="btn-remove" onclick="removeParameter(this)">削除</button>
          </div>
        </div>
        <button class="btn-add" onclick="addParameter()">パラメータを追加</button>
      </div>

      <div class="form-group">
        <button class="btn-test" onclick="testAPI()">テスト実行</button>
      </div>

      <div class="response-area">
        <h2>レスポンス</h2>
        <div id="loading" style="display: none;">送信中...</div>
        <pre id="response"></pre>
      </div>
    </div>

    <script>
      function addParameter() {
        const parametersDiv = document.getElementById('parameters');
        const newRow = document.createElement('div');
        newRow.className = 'parameter-row';
        newRow.innerHTML = `
          <input type="text" class="param-key" placeholder="Key">
          <input type="text" class="param-value" placeholder="Value">
          <button class="btn-remove" onclick="removeParameter(this)">削除</button>
        `;
        parametersDiv.appendChild(newRow);
      }

      function removeParameter(button) {
        const row = button.parentElement;
        if (document.querySelectorAll('.parameter-row').length > 1) {
          row.remove();
        }
      }

      function getParameters() {
        const params = {};
        const rows = document.querySelectorAll('.parameter-row');
        rows.forEach(row => {
          const key = row.querySelector('.param-key').value.trim();
          const value = row.querySelector('.param-value').value.trim();
          if (key) {
            params[key] = value;
          }
        });
        return params;
      }

      function testAPI() {
        const endpoint = document.getElementById('endpoint').value.trim();
        const method = document.getElementById('method').value;
        const parameters = getParameters();

        if (!endpoint) {
          alert('エンドポイントを入力してください');
          return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('response').textContent = '';

        google.script.run
          .withSuccessHandler(displayResponse)
          .withFailureHandler(displayError)
          .makeAPIRequest(endpoint, method, parameters);
      }

      function displayResponse(result) {
        document.getElementById('loading').style.display = 'none';
        const responseDiv = document.getElementById('response');

        if (result.error) {
          responseDiv.innerHTML = `<span class="error">エラー: ${result.error}</span>`;
        } else {
          let displayText = `ステータスコード: ${result.statusCode}\n\n`;
          if (result.headers) {
            displayText += `ヘッダー:\n${JSON.stringify(result.headers, null, 2)}\n\n`;
          }
          displayText += `レスポンスボディ:\n${result.body}`;
          responseDiv.textContent = displayText;
        }
      }

      function displayError(error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('response').innerHTML = `<span class="error">エラー: ${error.message}</span>`;
      }
    </script>
  </body>
</html>